/* Chrjs-Store
 * A modular store for TiddlySpace
 *
 * See https://github.com/bengillies/chrjs.store for more
 *
 * Dependencies: chrjs library, jQuery, TiddlySpace
 *
 * Version: 0.5.0
 *
 * created by Ben Gillies
 * Chrjs-Store is distributed under a BSD License
 *//* Taken and modified from ACE IDE to provide a lightweight RequireJS that
 * loads dependencies immediately, instead of inside a setTimeout (as RequireJS
 * does). See:
 * (https://github.com/mozilla/ace/blob/master/build_support/mini_require.js)
 * for the original version.
 *
 * ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is Ajax.org Code Editor (ACE).
 *
 * The Initial Developer of the Original Code is
 * Ajax.org B.V.
 * Portions created by the Initial Developer are Copyright (C) 2010
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *      Fabian Jakobs <fabian AT ajax DOT org>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *//**
 * Define a module along with a payload
 * @param module a name for the payload
 * @param payload a function to call with (require, exports, module) params
 */(function(){var a=window.define;window.define=function(a,b,c){typeof define.original=="function"&&define.original.apply(this,arguments);if(typeof a!="string")return;arguments.length===2&&(c=b),define.modules||(define.modules={require:{payload:window.require,deps:[]},define:{payload:window.define,deps:[]},exports:{payload:{},deps:[]},module:{payload:{},deps:[]}}),define.modules[a]={payload:c,deps:b}},define.original=a,define.modules=a&&a.modules?a.modules:{};var b=window.require;window.require=function(a,b){var d,e,f,g,h;if(Object.prototype.toString.call(a)==="[object Array]"){d=[];for(g=0,h=a.length;g<h;++g){e=c(a[g]);if(e)d.push(e);else return require.original.apply(this,arguments),null}b&&b.apply(null,d)}else if(typeof a=="string")return f=c(a),f?(b&&b(),f):require.original.apply(this,arguments)},require.original=b;var c=function(a){var b=define.modules[a],d=b?b.payload:null,e=b?b.deps:null;if(!d)return null;if(typeof d=="function"){var f={},g,h=[],i;for(g=0;g<e.length;g++)h.push(c(e[g]));return h.length===0&&(h=[require,f,{id:a,uri:""}]),i=d.apply(this,h),i||f}return d}})(),define("filter-syntax",["require","exports","module"],function(){var a=function(a,b){return function(c){var d=c.slice(a).split(b);return[d[0],d[1]]}},b={whitespace:/((?:\s|,).*)/,doubleSquare:/\]\](.*)/,doubleQuote:/"(.*)/},c={title:{match:/^\[\[[^\]\]]+\]\]/,action:a(2,b.doubleSquare),tiddlerTest:function(a){return function(b){return b.title===a?!0:!1}}},tag:{match:/^#.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.tags&&~b.tags.indexOf(a)?!0:!1}}},field:{match:/^\[[^!=\]]+!?=[^\]]+\]/,action:function(a){var b=a.indexOf("!="),c=!!~b,d=c?b:a.indexOf("="),e=a.indexOf("]"),f,g;return field=a.slice(1,d),rest=a.slice(e+1),c?g=a.slice(d+2,e):g=a.slice(d+1,e),f={field:field,value:g,not:c},[f,rest]},tiddlerTest:function(a){return function(b){var c=b[a.field]||(b.fields&&b.fields[a.field])===a.value?!0:!1;return a.not?!c:c}}},space:{match:/^@.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.bag.name.split(/_(public|private)$/)[0]===a?!0:!1}}},modifier:{match:/^\+.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.modifier===a?!0:!1}}},text:{match:/^"[^"]+"/,action:a(1,b.doubleQuote),tiddlerTest:function(a){return function(b){return b.text&&~b.text.indexOf(a)?!0:!1}}},not:{match:/!(?:\W|,)+/,action:function(a){return["not",a.slice(1)]}},subBlock:{match:/\(.+/,action:function(a){var b=1,c,d,e,f=-1,g,h;for(c=1,d=a.length;c<d;c++){e=a.charAt(c),e==="("?b++:e===")"&&b--;if(b===0){f=c;break}}if(~f)return g=a.slice(1,f),h=a.slice(f+1),[g,h];throw{name:"ParseError",message:"Brackets don't match"}}},or:{match:/^,/,action:function(a){return["or",a.slice(1)]}}},d=function(a){var b=$.trim(a),d=null,e,f,g;return $.each(c,function(a,c){if(c.match.test(b))return d=a,!1}),d?(e=c[d].action(b),g=e[0],f=e[1]||"",[d,g,f]):!1},e;e=function(a){var b=function(a){return{type:a[0],value:a[1]}},c,g,h;c=b(a);switch(c.type){case"not":g=e(d(a[2])),c.value=g[0],h=g[1];break;case"subBlock":c=f(a[1]),h=a[2];break;default:h=a[2]}return[c,h]};var f=function(a){var b={type:"or",value:[]},c,f,g={type:"and",value:[]},h=d(a);while(h)h[0]==="or"?(f=h[2],g.length===1?b.value.push(g.value[0]):b.value.push(g),g={type:"and",value:[]}):(c=e(h),f=c[1],g.value.push(c[0])),h=d(f);g.value.length===1?b.value.push(g.value[0]):g.value.length>1&&b.value.push(g);if(b.value.length===1)return b.value[0];if(b.value.length>1)return b;throw{name:"ParseError",message:"No filter found"}},g=function(a){return function(b){var c=!0;return $.each(a,function(a,d){if(!d(b))return c=!1,!1}),c}},h=function(a){return function(b){var c=!1;return $.each(a,function(a,d){if(d(b))return c=!0,!1}),c}},i=function(a){var b,d,e;return b=function(a){var d,e=[];switch(a.type){case"and":$.each(a.value,function(a,c){e.push(b(c))}),d=g(e);break;case"or":$.each(a.value,function(a,c){e.push(b(c))}),d=h(e);break;case"not":e=b(a.value),d=function(a){return!e(a)};break;case"function":d=function(b){return a.value(b)?!0:!1};break;default:d=c[a.type].tiddlerTest(a.value)}return d},e=b(a),d=function(a){var b=$.extend(!0,new tiddlyweb.Tiddler,a);return e(b)},d};return{parse:f,match:d,createTester:i}}),define("filter",["filter-syntax"],function(a){var b,c;return b=function(a,c){var d=[];return d.store=a,d.ast={type:"and",value:[]},c&&$.each(c,function(a,b){d.push(b)}),$.extend(d,b.fn),d},c=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1},b.fn={find:function(b){var c=a.parse(b),d;return d=a.createTester(c),this.map(function(a){return d(a)?a:null})},tag:function(a){return this.map(function(b){return c(b.tags,a)?b:null})},text:function(a){return this.map(function(b){return c(b.text,a)?b:null})},title:function(a){return this.map(function(b){return c(b.title,a)?b:null})},attr:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?a:null:c(e(a),b)?a:null})},not:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?null:a:c(e(a),b)?null:a})},bag:function(a){return this.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/,c,d;return a===!0||a===undefined?c=!0:a===!1&&(c=!1),c!==undefined&&(d=this.store.recipe&&this.store.recipe.name.replace(b,"")),this.map(function(e){var f=(e.bag&&e.bag.name).replace(b,"");return d||(d=this.store.recipe&&this.store.recipe.name.replace(b,"")||f),c?f===d?e:null:c===!1?f===d?null:e:f===a?e:null})},recipe:function(a){var b=a===undefined?!0:!1,c;return b&&(c=this.store.recipe.name),this.map(function(d){return b||(c=d.recipe&&d.recipe.name),c===a?d:null})},dirty:function(a){return a?this.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):this.map(function(a){return a.lastSync?null:a})},sort:function(a){var b=typeof a=="string"?a.split(/,\s*/):null,c=Array.prototype.sort;return b?c.call(this,function(a,c){var d=0;return $.each(b,function(b,e){var f=e.charAt(0)==="-"?!0:!1,g=f?e.slice(1):e,h=a[g]||a.fields&&a.fields[g]||null,i=c[g]||c.fields&&c.fields[g]||null;typeof h=="string"&&(h=h.toLowerCase()),typeof i=="string"&&(i=i.toLowerCase()),f?d=h>i?-1:h<i?1:null:d=h>i?1:h<i?-1:null;if(d)return!1}),d}):c.call(this,a)},limit:function(a){var c=b(this.store),d,e;for(d=0,e=this.length;d<a&&d<e;d++)c.push(this[d]);return c},each:function(a){var b=this;return $.each(b,function(c,d){a.apply(b,[d,c])}),b},map:function(a){var c=this,d=b(c.store);return d.ast=c.ast,d.ast.value.push({type:"function",value:function(b){var c=a.apply(d,[b]);return c?!0:!1}}),$.each(c,function(b,e){var f=a.apply(c,[e]);f&&d.push(f)}),d},reduce:function(a,b){var c=a,d=this;return $.each(d,function(a,e){c=b.apply(d,[e,c])}),c},unique:function(){var a={},c=this,d=b(c.store);return $.each(this,function(b,c){a[c.title]?c.lastSync||(a[c.title]=c):a[c.title]=c}),$.each(a,function(a,b){d.push(b)}),d},bind:function(b){var c=this,d=function(){b.apply(c,arguments)};return c.store.bind("filter",a.createTester(c.ast),d),c},save:function(a){var b=this;return $.each(b,function(c,d){b.store.save(d,a)}),b},add:function(a){var b=this;return a instanceof tiddlyweb.Tiddler?(b.push(a),b.store.add(a)):$.each(a,function(c,d){b.push(d),b.store.add(a)}),b}},b}),define("event",["require","exports","module"],function(){return function(){var a={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]},filter:[]},b={bind:function(b,c,d){b==="filter"?a.filter.push({test:c,callback:d}):a[b]&&(c?(a[b][c+b]||(a[b][c+b]=[]),a[b][c+b].push(d)):a[b].all.push(d))},unbind:function(b,c,d){var e=function(a){return d?($.each(a,function(b,c){d===c&&a.splice(b,1)}),a):[]};b==="filter"?$.each(a.filter,function(b,c){c.test===d&&a.filter.splice(b,1)}):a[b]&&c?a[b][c+b]=e(a[b][c+b]):a[b].all=e(a[b].all)},trigger:function(b,c,d){var e=$.isArray(d)?d:[d],f,g=this;a[b]&&($.each(a[b].all,function(a,b){b.apply(g,e)}),c&&a[b][c+b]&&$.each(a[b][c+b],function(a,b){b.apply(g,e)})),b==="tiddler"&&(f=d instanceof tiddlyweb.Tiddler?d:d[0],$.each(a.filter,function(a,b){b.test(f)&&b.callback.apply(g,e)}))}};return b}}),define("cache",["require","exports","module"],function(){var a=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}();return{isCaching:a,set:function(b,c){a&&window.localStorage.setItem(b,JSON.stringify(c.baseData()))},get:function(b,c){var d,e;return a?(e=window.localStorage[b],d=new tiddlyweb.Tiddler(c.title),d=d.parse(JSON.parse(e)),d.bag=c.bag,d):null},remove:function(b){a&&window.localStorage.removeItem(b)},list:function(){var b=[],c,d;if(a)for(c=0,d=window.localStorage.length;c<d;c++)try{var e=window.localStorage.key(c),f,g,h,i,j;f=e.split("/");if(f.length!==2)throw"BadKey";g=decodeURIComponent(f[0]),h=decodeURIComponent(f[1]),i=JSON.parse(window.localStorage[e]),j=new tiddlyweb.Tiddler(h),j=j.parse(i),g&&(j.bag=new tiddlyweb.Bag(g,"/")),b.push(j)}catch(k){}return b},clear:function(){a&&window.localStorage.clear()}}}),define("localStore",["cache"],function(a){return function(b){var c={},d=[],e=b.addLastSync!==undefined?b.addLastSync:!0,f=b.useCache,g=function(a){var b=a.bag||"";return encodeURIComponent(b.name)+"/"+encodeURIComponent(a.title)},h=function(a){return $.extend(!0,new tiddlyweb.Tiddler,a)},i=function(a){var b=c[g(a)],e;if(b)return h(b);if(!a.bag){e=$.extend(new tiddlyweb.Tiddler,a);for(var f=0,i=d.length;f<i;f++){a.bag=d[f],b=c[g(a)];if(b)return h(b)}}return null},j=function(b){var i=$.map(d,function(a,b){return b.name});k(new tiddlyweb.Tiddler(b.title)),b.bag&&!~i.indexOf(b.bag.name)&&d.push(b.bag),b.lastSync=e?new Date:null;var j=g(b);c[j]=h(b),f&&a.set(j,b)},k=function(b){var d=g(b),e=c[d];return delete c[g(b)],f&&a.remove(d),e},l=function(){var a=[];return $.each(c,function(b,c){a.push(h(c))}),a},m=function(){return d};return{get:i,set:j,remove:k,list:l,bags:m}}}),define("host",["require","exports","module"],function(){return function(a){var b,c=[];a instanceof tiddlyweb.Recipe||a instanceof tiddlyweb.Bag?b={pullFrom:a,pushTo:a}:a&&(b={pullFrom:a.pullFrom,pushTo:a.pushTo});var d=function(a){$.ajax({url:"/?limit=1",dataType:"json",success:function(b){var c=($.isArray(b)?b[0].recipe:b.recipe)||"",d=c.match(/^(.+)_[^_]+$/),e;d&&c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Bag(d[1]+"_public","/")}):c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Recipe(c,"/")}):(e=$.isArray(b)?b[0].bag:b.bag,a({pullFrom:new tiddlyweb.Bag(e,"/"),pushTo:new tiddlyweb.Bag(e,"/")}))},error:function(b,c,d){a(null,d,b)}})},e=function(a){var e=function(a){return $.each(c,function(b,c){c(a)}),c=[],a};a&&c.push(a);if(b)return e(b);c.length===0&&d(function(a){b=a,e(a)})};return e(),{getDefault:e}}}),define("store",["filter","event","cache","localStore","host"],function(a,b,c,d,e){return function(f,g,h){g===undefined&&(g=!0);var i,j=b(),k=e(h),l=d({addLastSync:!0}),m=d({addLastSync:!1,useCache:!0}),n=function(b,c){var d=a(i,c).map(function(a){return a.title});i.each(function(a,c){a.recipe&&a.recipe.name===b.name&&d.indexOf(a.title)===-1&&(l.remove(a),i.trigger("tiddler",c,[a,"deleted"]))})},o=function(a,b){for(name in a)switch(typeof a[name]){case"object":if(!o(a[name],b[name]))return!1;break;case"function":break;default:if(a[name]!==b[name])return!1}for(name in b)if(typeof a[name]=="undefined"&&typeof b[name]!="undefined")return!1;return!0},p;return p=function(a,b){var c=a.get(b),d,e;return d=function(){return c&&c.lastSync&&c.revision!==b.revision},e=function(){return c&&!c.lastSync&&!o(b,c)},a.set(b),b.bag&&(!c||d()||e())&&i.trigger("tiddler",b.title,b),!0},i=function(b,c){var d=a(i);return i.each(function(a,b){d.push(a)}),typeof c=="undefined"&&typeof b=="string"?d=d.find(b):typeof b=="function"?d=d.map(b):d[b]?d=d[b](c):b&&(d=d.attr(b,c)),d},i.recipe=null,i.Collection=function(){return function(){var b=Array.prototype.slice.call(arguments);return b.unshift(i),a.apply(i,b)}}(),i.fn=a.fn,i.getDefaults=function(a){i.recipe||k.getDefault(function(a){i.recipe=a.pullFrom});if(a)k.getDefault(a);else return k.getDefault();return i},i.bind=function(){return j.bind.apply(i,arguments),i},i.unbind=function(){return j.unbind.apply(i,arguments),i},i.trigger=function(){return j.trigger.apply(i,arguments),i},i.refresh=function(b){var c=function(c){var d=c.tiddlers();d.get(function(d){$.each(d,function(a,b){p(l,b)}),n(c,d),b&&b.call(i,a(i,d))},function(a,c,d){b(null,{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+d},a)})};return i.recipe?c(i.recipe):i.getDefaults(function(a){c(a.pullFrom)}),i},i.get=function(a,b,c,d){var e=(a instanceof tiddlyweb.Tiddler?m.get(a):m.get(new tiddlyweb.Tiddler(a)))||null,f=function(){var b=!d&&e?e:a;return b instanceof tiddlyweb.Tiddler?b:(i.each(function(a,c){if(c===b)return b=a,!1}),b instanceof tiddlyweb.Tiddler?b:null)}();if(!b&&f)return f;if(!d&&e)b.call(i,f);else if(f)f.get(function(a){p(l,a),b.call(i,a)},function(a,c,d){b.call(i,null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d},a)},c?"render=1":"");else if(b)b.call(i,null,{name:"NotFoundError",message:"Tiddler not found"});else return null;return i},i.each=function(a){var b=!0;return $.each(m.list(),function(c,d){return b=a(d,c),b}),(b||typeof b=="undefined")&&$.each(l.list(),function(b,c){return a(c,c.title)}),i},i.add=function(a){var b=function(a){p(m,a)};return a.bag?b(a):(b(a),i.getDefaults(function(c){a.bag=c.pushTo,b(a)})),i},i.save=function(a,b){var c=!0,d=a instanceof tiddlyweb.Tiddler,e=!d&&a?a:b,f=function(a,b){var c=m.get(a);if(!a.bag){i.getDefaults(function(c){a.bag=c.pushTo,f(a,b)});return}a.put(function(d){o(c,m.get(a))&&m.remove(a),p(l,d),b(d)},function(d,e,f){var g=m.get(a);(!g||!o(c,a)&&o(c,g))&&p(m,a),b(null,{name:"SaveError",message:"Error saving "+a.title+": "+f},d)})};return d?(f(a,e),i):($.each(m.list(),function(a,b){c&&(c=!1),f(b,e)}),c&&e(null,{name:"EmptyError",message:"Nothing to save"}),i)},i.remove=function(a,b){var c={pending:!0,server:!1,tiddler:a,callback:b||function(){}};return typeof a=="string"?c.tiddler=i.get(a):a instanceof tiddlyweb.Tiddler||$.extend(c,a),c.tiddler?(c.pending&&m.remove(c.tiddler),c.server&&(c.tiddler.bag||c.tiddler.recipe)?c.tiddler["delete"](function(a){l.remove(a),i.trigger("tiddler",a.title,[a,"deleted"]),c.callback(a)},function(a,b,d){c.callback(c.pending?c.tiddler:null,{name:"DeleteError",message:"Error deleting "+c.tiddler.title+": "+d},a)}):(i.trigger("tiddler",c.tiddler.title,[c.tiddler,"deleted"]),c.callback(c.tiddler)),i):i},i.search=function(b,c){return i.getDefaults(function(d){var e=new tiddlyweb.Search(b,d.pullFrom.host);e.get(function(b){$.each(b,function(a,b){l.set(b)}),c(a(i,b))},function(a,b,d){c(null,{name:"SearchError",message:"Error retrieving tiddlers from search: "+d},a)})}),i},$.ajaxSetup({beforeSend:function(a){a.setRequestHeader("X-ControlView","false")}}),i.retrieveCached=function(){return $.each(c.list(),function(a,b){i.add(b)}),i},g&&i.retrieveCached(),f&&i.refresh(f),i}}),function(a){require(["store"],function(b){a.Store=b})}(window.tiddlyweb)