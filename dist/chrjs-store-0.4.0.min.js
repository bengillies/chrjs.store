/* Chrjs-Store
 * A modular store for TiddlySpace
 *
 * See https://github.com/bengillies/chrjs.store for more
 *
 * Dependencies: chrjs library, jQuery, TiddlySpace
 *
 * Version: 0.4.0
 *
 * created by Ben Gillies
 * Chrjs-Store is distributed under a BSD License
 *//* Taken and modified from ACE IDE to provide a lightweight RequireJS that
 * loads dependencies immediately, instead of inside a setTimeout (as RequireJS
 * does). See:
 * (https://github.com/mozilla/ace/blob/master/build_support/mini_require.js)
 * for the original version.
 *
 * ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is Ajax.org Code Editor (ACE).
 *
 * The Initial Developer of the Original Code is
 * Ajax.org B.V.
 * Portions created by the Initial Developer are Copyright (C) 2010
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *      Fabian Jakobs <fabian AT ajax DOT org>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *//**
 * Define a module along with a payload
 * @param module a name for the payload
 * @param payload a function to call with (require, exports, module) params
 */(function(){var a=window.define;window.define=function(a,b,c){typeof define.original=="function"&&define.original.apply(this,arguments);typeof a=="string"&&(arguments.length===2&&(c=b),define.modules||(define.modules={require:{payload:window.require,deps:[]},define:{payload:window.define,deps:[]},exports:{payload:{},deps:[]},module:{payload:{},deps:[]}}),define.modules[a]={payload:c,deps:b})},define.original=a,define.modules=a&&a.modules?a.modules:{};var b=window.require;window.require=function(a,b){var d,e,f,g,h;if(Object.prototype.toString.call(a)==="[object Array]"){d=[];for(g=0,h=a.length;g<h;++g){e=c(a[g]);if(e)d.push(e);else{require.original.apply(this,arguments);return null}}b&&b.apply(null,d)}else if(typeof a=="string"){f=c(a);if(!f)return require.original.apply(this,arguments);b&&b();return f}},require.original=b;var c=function(a){var b=define.modules[a],d=b?b.payload:null,e=b?b.deps:null;if(!d)return null;if(typeof d=="function"){var f={},g,h=[],i;for(g=0;g<e.length;g++)h.push(c(e[g]));h.length===0&&(h=[require,f,{id:a,uri:""}]),i=d.apply(this,h);return i||f}return d}})(),define("filter-syntax",["require","exports","module"],function(){var a=function(a,b){return function(c){var d=c.slice(a).split(b);return[d[0],d[1]]}},b={whitespace:/((?:\W|,).*)/,doubleSquare:/\]\](.*)/,doubleQuote:/"(.*)/},c={title:{match:/^\[\[[^\]\]]+\]\]/,action:a(2,b.doubleSquare),tiddlerTest:function(a){return function(b){return b.title===a?!0:!1}}},tag:{match:/^#.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return~b.tags.indexOf(a)?!0:!1}}},field:{match:/^\[[^!=\]]+!?=[^\]]+\]/,action:function(a){var b=a.indexOf("!="),c=!!~b,d=c?b:a.indexOf("="),e=a.indexOf("]"),f,g;field=a.slice(1,d),rest=a.slice(e+1),c?g=a.slice(d+2,e):g=a.slice(d+1,e),f={field:field,value:g,not:c};return[f,rest]},tiddlerTest:function(a){return function(b){var c=b[a.field]||(b.fields&&b.fields[a.field])===a.value?!0:!1;return a.not?!c:c}}},space:{match:/^@.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.bag.name.split(/_(public|private)$/)[0]===a?!0:!1}}},modifier:{match:/^\+.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.modifier===a?!0:!1}}},text:{match:/^"[^"]+"/,action:a(1,b.doubleQuote),tiddlerTest:function(a){return function(b){return~b.text.indexOf(a)?!0:!1}}},not:{match:/!(?:\W|,)+/,action:function(a){return["not",a.slice(1)]}},subBlock:{match:/\(.+/,action:function(a){var b=1,c,d,e,f=-1,g,h;for(c=1,d=a.length;c<d;c++){e=a.charAt(c),e==="("?b++:e===")"&&b--;if(b===0){f=c;break}}if(~f){g=a.slice(1,f),h=a.slice(f+1);return[g,h]}throw{name:"ParseError",message:"Brackets don't match"}}},or:{match:/^,/,action:function(a){return["or",a.slice(1)]}}},d=function(a){var b=$.trim(a),d=null,e,f,g;$.each(c,function(a,c){if(c.match.test(b)){d=a;return!1}});if(d){e=c[d].action(b),g=e[0],f=e[1]||"";return[d,g,f]}return!1},e;e=function(a){var b=function(a){return{type:a[0],value:a[1]}},c,g,h;c=b(a);switch(c.type){case"not":g=e(d(a[2])),c.value=g[0],h=g[1];break;case"subBlock":c=f(a[1]),h=a[2];break;default:h=a[2]}return[c,h]};var f=function(a){var b={type:"or",value:[]},c,f,g={type:"and",value:[]},h=d(a);while(h)h[0]==="or"?(f=h[2],g.length===1?b.value.push(g.value[0]):b.value.push(g),g={type:"and",value:[]}):(c=e(h),f=c[1],g.value.push(c[0])),h=d(f);g.value.length===1?b.value.push(g.value[0]):g.value.length>1&&b.value.push(g);if(b.value.length===1)return b.value[0];if(b.value.length>1)return b;throw{name:"ParseError",message:"No filter found"}},g=function(a){return function(b){var c=!0;$.each(a,function(a,d){if(!d(b)){c=!1;return!1}});return c}},h=function(a){return function(b){var c=!1;$.each(a,function(a,d){if(d(b)){c=!0;return!1}});return c}},i=function(a){var b,d,e;b=function(a){var d,e=[];switch(a.type){case"and":$.each(a.value,function(a,c){e.push(b(c))}),d=g(e);break;case"or":$.each(a.value,function(a,c){e.push(b(c))}),d=h(e);break;case"not":e=b(a.value),d=function(a){return!e(a)};break;case"function":d=function(b){return a.value(b)?!0:!1};break;default:d=c[a.type].tiddlerTest(a.value)}return d},e=b(a),d=function(a){var b=$.extend(!0,new tiddlyweb.Tiddler,a);return e(b)};return d};return{parse:f,match:d,createTester:i}}),define("filter",["filter-syntax"],function(a){var b,c;b=function(a,c){var d=[];d.store=a,d.ast={type:"and",value:[]},c&&$.each(c,function(a,b){d.push(b)}),$.extend(d,b.fn);return d},c=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1},b.fn={find:function(b){var c=a.parse(b),d;d=a.createTester(c);return this.map(function(a){return d(a)?a:null})},tag:function(a){return this.map(function(b){return c(b.tags,a)?b:null})},text:function(a){return this.map(function(b){return c(b.text,a)?b:null})},title:function(a){return this.map(function(b){return c(b.title,a)?b:null})},attr:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?a:null:c(e(a),b)?a:null})},not:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?null:a:c(e(a),b)?null:a})},bag:function(a){return this.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/,c,d;a===!0||a===undefined?c=!0:a===!1&&(c=!1),c!==undefined&&(d=this.store.recipe&&this.store.recipe.name.replace(b,""));return this.map(function(e){var f=(e.bag&&e.bag.name).replace(b,"");d||(d=this.store.recipe&&this.store.recipe.name.replace(b,"")||f);return c?f===d?e:null:c===!1?f===d?null:e:f===a?e:null})},recipe:function(a){var b=a===undefined?!0:!1,c;b&&(c=this.store.recipe.name);return this.map(function(d){b||(c=d.recipe&&d.recipe.name);return c===a?d:null})},dirty:function(a){return a?this.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):this.map(function(a){return a.lastSync?null:a})},each:function(a){var b=this;$.each(b,function(c,d){a.apply(b,[d,c])});return b},map:function(a){var c=this,d=b(c.store);d.ast=c.ast,d.ast.value.push({type:"function",value:function(b){var c=a.apply(d,[b]);return c?!0:!1}}),$.each(c,function(b,e){var f=a.apply(c,[e]);f&&d.push(f)});return d},reduce:function(a,b){var c=a,d=this;$.each(d,function(a,e){c=b.apply(d,[e,c])});return c},unique:function(){var a={},c=this,d=b(c.store);$.each(this,function(b,c){a[c.title]?c.lastSync||(a[c.title]=c):a[c.title]=c}),$.each(a,function(a,b){d.push(b)});return d},bind:function(b){var c=this,d=function(){b.apply(c,arguments)};c.store.bind("filter",a.createTester(c.ast),d);return c},save:function(a){var b=this;$.each(b,function(c,d){b.store.save(d,a)});return b},add:function(a){var b=this;a instanceof tiddlyweb.Tiddler?(b.push(a),b.store.add(a)):$.each(a,function(c,d){b.push(d),b.store.add(a)});return b}};return b}),define("event",["require","exports","module"],function(){return function(){var a={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]},filter:[]},b={bind:function(b,c,d){b==="filter"?a.filter.push({test:c,callback:d}):a[b]&&(c?(a[b][c+b]||(a[b][c+b]=[]),a[b][c+b].push(d)):a[b].all.push(d))},unbind:function(b,c,d){var e=function(a){if(d){$.each(a,function(b,c){d===c&&a.splice(b,1)});return a}return[]};b==="filter"?$.each(a.filter,function(b,c){c.test===d&&a.filter.splice(b,1)}):a[b]&&c?a[b][c+b]=e(a[b][c+b]):a[b].all=e(a[b].all)},trigger:function(b,c,d){var e=$.isArray(d)?d:[d],f,g=this;a[b]&&($.each(a[b].all,function(a,b){b.apply(g,e)}),c&&a[b][c+b]&&$.each(a[b][c+b],function(a,b){b.apply(g,e)})),b==="tiddler"&&(f=d instanceof tiddlyweb.Tiddler?d:d[0],$.each(a.filter,function(a,b){b.test(f)&&b.callback.apply(g,e)}))}};return b}}),define("cache",["require","exports","module"],function(){var a=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}(),b=function(a){var b=a.bag&&a.bag.name||"";return encodeURIComponent(b)+"/"+encodeURIComponent(a.title)};return{isCaching:a,set:function(c){var d=b(c);a&&window.localStorage.setItem(d,c.toJSON())},get:function(c){var d=b(c),e,f;if(a){e=window.localStorage[d],f=$.parseJSON(e),e=new tiddlyweb.Tiddler(c.title),e.bag=c.bag,$.extend(e,f);return e}return null},remove:function(c){var d=b(c),e="/"+d.split("/")[1];a&&(window.localStorage.removeItem(d),window.localStorage.removeItem(e))},list:function(){var b=[],c,d;if(a)for(c=0,d=window.localStorage.length;c<d;c++)try{var e=window.localStorage.key(c),f,g,h,i,j;f=e.split("/");if(f.length!==2)throw"BadKey";g=decodeURIComponent(f[0]),h=decodeURIComponent(f[1]),i=$.parseJSON(window.localStorage[e]),j=new tiddlyweb.Tiddler(h),g&&(j.bag=new tiddlyweb.Bag(g,"/")),$.extend(j,i),b.push(j)}catch(k){}return b},clear:function(){a&&window.localStorage.clear()}}}),define("localStore",["require","exports","module"],function(){return function(a){var b={},c=[],d=a.addLastSync!==undefined?a.addLastSync:!0,e=function(a){var b=a.bag||"";return encodeURIComponent(b.name)+"/"+encodeURIComponent(a.title)},f=function(a){return $.extend(!0,new tiddlyweb.Tiddler,a)},g=function(a){var d=b[e(a)];if(d)return f(d);for(var g=0,h=c.length;g<h;g++){a.bag=c[g],d=b[e(a)];if(d){a.bag=undefined;return f(d)}}return null},h=function(a){var g=$.map(c,function(a,b){return b.name});delete b[e(new tiddlyweb.Tiddler(a.title))],a.bag&&!~g.indexOf(a.bag.name)&&c.push(a.bag),a.lastSync=d?new Date:null,b[e(a)]=f(a)},i=function(a){var c=e(a),d=b[c];delete b[e(a)];return d},j=function(){var a=[];$.each(b,function(b,c){a.push(c)});return a},k=function(){return c};return{get:g,set:h,remove:i,list:j,bags:k}}}),define("host",["require","exports","module"],function(){return function(a){var b,c=[];a instanceof tiddlyweb.Recipe||a instanceof tiddlyweb.Bag?b={pullFrom:a,pushTo:Container}:a&&(b={pullFrom:a.pullFrom,pushTo:a.pushTo});var d=function(a){$.ajax({url:"/?limit=1",dataType:"json",success:function(b){var c=($.isArray(b)?b[0].recipe:b.recipe)||"",d=c.match(/^(.+)_[^_]+$/),e;d&&c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Bag(d[1]+"_public","/")}):c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Recipe(c,"/")}):(e=$.isArray(b)?b[0].bag:b.bag,a({pullFrom:new tiddlyweb.Bag(e,"/"),pushTo:new tiddlyweb.Bag(e,"/")}))},error:function(b,c,d){a(null,d,b)}})},e=function(a){var e=function(a){$.each(c,function(b,c){c(a)}),c=[];return a};a&&c.push(a);if(b)return e(b);d(function(a){b=a,e(a)})};e();return{getDefault:e}}}),define("store",["filter","event","cache","localStore","host"],function(a,b,c,d,e){return function(f,g,h){g===undefined&&(g=!0);var i,j=b(),k=e(h),l=d({addLastSync:!0}),m=d({addLastSync:!1}),n=function(b,c){var d=a(i,c).map(function(a){return a.title});i.each(function(a,c){a.recipe&&a.recipe.name===b.name&&d.indexOf(a.title)===-1&&(l.remove(a),i.trigger("tiddler",c,[a,"deleted"]))})},o;o=function(a){var b=l.get(a);l.set(a),b&&b.revision!==a.revision&&i.trigger("tiddler",a.title,a);return!0},i=function(b,c){var d=a(i);i.each(function(a,b){d.push(a)}),typeof c=="undefined"&&typeof b=="string"?d=d.find(b):typeof b=="function"?d=d.map(b):d[b]?d=d[b](c):b&&(d=d.attr(b,c));return d},i.recipe=null,i.fn=a.fn,i.getDefaults=function(a){if(a)k.getDefault(a);else return k.getDefault();return i},i.bind=function(){j.bind.apply(i,arguments);return i},i.unbind=function(){j.unbind.apply(i,arguments);return i},i.trigger=function(){j.trigger.apply(i,arguments);return i},i.refresh=function(a){var b=function(b){var c=b.tiddlers();c.get(function(c){$.each(c,function(a,b){o(b)}),n(b,c),a&&a.apply(i,[c])},function(b,c,d){a(null,{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+d},b)})};i.recipe?b(i.recipe):i.getDefaults(function(a){b(a.pullFrom)});return i},i.get=function(a,b,c,d){var e=(a instanceof tiddlyweb.Tiddler?m.get(a):m.get(new tiddlyweb.Tiddler(a)))||null,f=function(){var b=!d&&e?e:a;if(b instanceof tiddlyweb.Tiddler)return b;i.each(function(a,c){if(c===b){b=a;return!1}});return b instanceof tiddlyweb.Tiddler?b:null}();if(!b&&f)return f;if(!d&&e)b.call(i,f);else if(f)f.get(function(a){o(a),b.call(i,a)},function(a,c,d){b.call(i,null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d},a)},c?"render=1":"");else if(b)b.call(i,null,{name:"NotFoundError",message:"Tiddler not found"});else return null;return i},i.each=function(a){var b=!0;$.each(m.list(),function(c,d){b=a(d,c);return b}),(b||typeof b=="undefined")&&$.each(l.list(),function(b,c){return a(c,c.title)});return i},i.add=function(a){var b=function(a){c.remove(a),c.set(a),m.set(a),a.bag&&i.trigger("tiddler",a.title,a)};a.bag?b(a):(b(a),i.getDefaults(function(c){a.bag=c.pushTo,b(a)}));return i},i.save=function(a,b){var d=!0,e=a instanceof tiddlyweb.Tiddler,f=!e&&a?a:b,g=function(a,b){m.remove(a);a.bag?a.put(function(d){c.remove(a),o(d),b(d)},function(c,d,e){m.get(a)||m.set(a),b(null,{name:"SaveError",message:"Error saving "+a.title+": "+e},c)}):i.getDefaults(function(c){a.bag=c.pushTo,g(a,b)})};if(e){g(a,f);return i}$.each(m.list(),function(a,b){d&&(d=!1),g(b,f)}),d&&f(null,{name:"EmptyError",message:"Nothing to save"});return i},i.remove=function(a,b){var d={pending:!0,server:!1,tiddler:a,callback:b||function(){}};typeof a=="string"?d.tiddler=i.get(a):a instanceof tiddlyweb.Tiddler||$.extend(d,a);if(!d.tiddler)return i;d.pending&&(m.remove(d.tiddler),c.remove(d.tiddler)),d.server&&(d.tiddler.bag||d.tiddler.recipe)?d.tiddler["delete"](function(a){l.remove(a),i.trigger("tiddler",a.title,[a,"deleted"]),d.callback(a)},function(a,b,c){d.callback(d.pending?d.tiddler:null,{name:"DeleteError",message:"Error deleting "+d.tiddler.title+": "+c},a)}):(i.trigger("tiddler",d.tiddler.title,[d.tiddler,"deleted"]),d.callback(d.tiddler));return i},i.search=function(a,b){getDefaults(function(c){var d=new tiddlyweb.Search(a,c.pullFrom.host);d.get(function(a){$.each(a,function(a,b){l.set(b)}),b(a)},function(a,c,d){b(null,{name:"SearchError",message:"Error retrieving tiddlers from search: "+d},a)})});return i},$.ajaxSetup({beforeSend:function(a){a.setRequestHeader("X-ControlView","false")}}),i.retrieveCached=function(){$.each(c.list(),function(a,b){i.add(b)});return i},g&&i.retrieveCached(),f&&i.refresh(f);return i}}),function(a){require(["store"],function(b){a.Store=b})}(window.tiddlyweb)