/* Chrjs-Store
 * A modular store for TiddlySpace
 *
 * See https://github.com/bengillies/chrjs.store for more
 *
 * Dependencies: chrjs library, jQuery, TiddlySpace
 *
 * Version: 0.6.0
 *
 * created by Ben Gillies
 * Chrjs-Store is distributed under a BSD License
 *//**
 * almond 0.0.2+ Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 *//*jslint strict: false, plusplus: false *//*global setTimeout: false */var requirejs,require,define;(function(){function d(a,b){if(a&&a.charAt(0)==="."&&b){b=b.split("/"),b=b.slice(0,b.length-1),a=b.concat(a.split("/"));var c,d;for(c=0;d=a[c];c++)if(d===".")a.splice(c,1),c-=1;else if(d==="..")if(c!==1||a[2]!==".."&&a[0]!=="..")c>0&&(a.splice(c-1,2),c-=2);else break;a=a.join("/")}return a}function e(a,d){return function(){return c.apply(null,b.call(arguments,0).concat([a,d]))}}function f(a){return function(b){return d(b,a)}}function g(b){return function(c){a[b]=c}}function h(b,c){var e,g,h=b.indexOf("!");return h!==-1?(e=d(b.slice(0,h),c),b=b.slice(h+1),g=a[e],g&&g.normalize?b=g.normalize(b,f(c)):b=d(b,c)):b=d(b,c),{f:e?e+"!"+b:b,n:b,p:g}}function i(b,c,d,f){var i=[],j,k,l,m,n,o;f||(f=b);if(typeof d=="function"){if(c)for(m=0;m<c.length;m++)o=h(c[m],f),l=o.f,l==="require"?i[m]=e(b):l==="exports"?(i[m]=a[b]={},j=!0):l==="module"?k=i[m]={id:b,uri:"",exports:a[b]}:l in a?i[m]=a[l]:o.p&&(o.p.load(o.n,e(f,!0),g(l),{}),i[m]=a[l]);n=d.apply(a[b],i),b&&(k&&k.exports!==undefined?a[b]=k.exports:j||(a[b]=n))}else b&&(a[b]=d)}var a={},b=[].slice,c;if(typeof define=="function")return;requirejs=c=function(b,d,e,f){return typeof b=="string"?a[h(b,d).f]:(b.splice||(d.splice?(b=d,d=arguments[2]):b=[]),f?i(null,b,d,e):setTimeout(function(){i(null,b,d,e)},15),c)},c.config=function(){return c},require||(require=c),define=function(a,b,c){b.splice||(c=b,b=[]),i(a,b,c)},define.amd={jQuery:!0}})(),define("filter",[],function(){var a=function(a,b){return function(c){var d=c.slice(a).split(b);return[d[0],d[1]]}},b={whitespace:/((?:\s|,).*)/,doubleSquare:/\]\](.*)/,doubleQuote:/"(.*)/},c={title:{match:/^\[\[[^\]\]]+\]\]/,action:a(2,b.doubleSquare),tiddlerTest:function(a){return function(b){return b.title===a?!0:!1}}},tag:{match:/^#.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.tags&&~b.tags.indexOf(a)?!0:!1}}},field:{match:/^\[[^!=\]]+!?=[^\]]+\]/,action:function(a){var b=a.indexOf("!="),c=!!~b,d=c?b:a.indexOf("="),e=a.indexOf("]"),f,g;return field=a.slice(1,d),rest=a.slice(e+1),c?g=a.slice(d+2,e):g=a.slice(d+1,e),f={field:field,value:g,not:c},[f,rest]},tiddlerTest:function(a){return function(b){var c=b[a.field]||(b.fields&&b.fields[a.field])===a.value?!0:!1;return a.not?!c:c}}},space:{match:/^@.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){var c=/_(public|private|archive)$/;return b.bag.name.replace(c,"")===a?!0:!1}}},modifier:{match:/^\+.+/,action:a(1,b.whitespace),tiddlerTest:function(a){return function(b){return b.modifier===a?!0:!1}}},text:{match:/^"[^"]+"/,action:a(1,b.doubleQuote),tiddlerTest:function(a){return function(b){return b.text&&~b.text.indexOf(a)?!0:!1}}},not:{match:/!(?:\W|,)+/,action:function(a){return["not",a.slice(1)]}},subBlock:{match:/\(.+/,action:function(a){var b=1,c,d,e,f=-1,g,h;for(c=1,d=a.length;c<d;c++){e=a.charAt(c),e==="("?b++:e===")"&&b--;if(b===0){f=c;break}}if(~f)return g=a.slice(1,f),h=a.slice(f+1),[g,h];throw{name:"ParseError",message:"Brackets don't match"}}},or:{match:/^,/,action:function(a){return["or",a.slice(1)]}}},d=function(a){var b=$.trim(a),d=null,e,f,g;return $.each(c,function(a,c){if(c.match.test(b))return d=a,!1}),d?(e=c[d].action(b),g=e[0],f=e[1]||"",[d,g,f]):!1},e;e=function(a){var b=function(a){return{type:a[0],value:a[1]}},c,g,h;c=b(a);switch(c.type){case"not":g=e(d(a[2])),c.value=g[0],h=g[1];break;case"subBlock":c=f(a[1]),h=a[2];break;default:h=a[2]}return[c,h]};var f=function(a){var b={type:"or",value:[]},c,f,g={type:"and",value:[]},h=d(a);while(h)h[0]==="or"?(f=h[2],g.length===1?b.value.push(g.value[0]):b.value.push(g),g={type:"and",value:[]}):(c=e(h),f=c[1],g.value.push(c[0])),h=d(f);g.value.length===1?b.value.push(g.value[0]):g.value.length>1&&b.value.push(g);if(b.value.length===1)return b.value[0];if(b.value.length>1)return b;throw{name:"ParseError",message:"No filter found"}},g=function(a){return function(b){var c=!0;return $.each(a,function(a,d){if(!d(b))return c=!1,!1}),c}},h=function(a){return function(b){var c=!1;return $.each(a,function(a,d){if(d(b))return c=!0,!1}),c}},i=function(a){var b,d,e;return b=function(a){var d,e=[];switch(a.type){case"and":$.each(a.value,function(a,c){e.push(b(c))}),d=g(e);break;case"or":$.each(a.value,function(a,c){e.push(b(c))}),d=h(e);break;case"not":e=b(a.value),d=function(a){return!e(a)};break;case"function":d=function(b){return a.value(b)?!0:!1};break;default:d=c[a.type].tiddlerTest(a.value)}return d},e=b(a),d=function(a){var b=$.extend(!0,new tiddlyweb.Tiddler,a);return e(b)},d};return{parse:f,match:d,createTester:i,states:c}}),define("collection",["filter"],function(a){var b=function(a,c){var d=[];return d.store=a,d.ast={type:"and",value:[]},c?$.each(c,function(a,b){d.push(b)}):a.each(function(a){d.push(a)}),$.extend(d,b.fn),d};return b.fn={find:function(b,c){var d,e;return typeof c=="undefined"&&typeof b=="string"?(e=a.parse(b),d=a.createTester(e),this.filter(function(a){return d(a)?a:null})):typeof b=="function"?this.filter(b):this[b]?this[b](c):b?this.attr(b,c):this},tag:function(b){return this.filter(a.states.tag.tiddlerTest(b))},text:function(b){return this.filter(a.states.text.tiddlerTest(b))},title:function(b){return this.filter(a.states.title.tiddlerTest(b))},attr:function(b,c){return c?this.filter(a.states.field.tiddlerTest({field:b,value:c})):this.filter(function(a){return a[b]||a.fields&&a.fields[b]})},not:function(b,c){return c?this.filter(a.states.field.tiddlerTest({field:b,value:c,not:!0})):this.filter(function(a){return!(a[b]||a.fields&&a.fields[b])})},bag:function(a){return this.filter(function(b){var c=b.bag&&b.bag.name;return c===a?!0:!1})},space:function(b){var c=/(_public|_private|_archive)$/,d=!1,e,f=a.states.space.tiddlerTest,g,h=function(a){return a?a.name.replace(c,""):null};return b===!1?d=!0:typeof b=="string"&&(g=f(b)),g||(e=h(this.store.recipe),g=e?f(e):null),this.filter(function(a){return g||(g=f(this.store.recipe||a.bag)),d?!g(a):g(a)},this)},recipe:function(a){var b=a===undefined?!0:!1,c;return b&&(c=this.store.recipe.name),this.filter(function(d){return b||(c=d.recipe&&d.recipe.name),c===a?!0:!1})},dirty:function(a){return a?this.filter(function(b){return b.lastSync?+b.lastSync<+a?!0:!1:!0}):this.filter(function(a){return a.lastSync?!1:!0})},sort:function(a){var b=typeof a=="string"?a.split(/,\s*/):null,c=Array.prototype.sort;return b?c.call(this,function(a,c){var d=0;return $.each(b,function(b,e){var f=e.charAt(0)==="-"?!0:!1,g=f?e.slice(1):e,h=a[g]||a.fields&&a.fields[g]||null,i=c[g]||c.fields&&c.fields[g]||null;typeof h=="string"&&(h=h.toLowerCase()),typeof i=="string"&&(i=i.toLowerCase()),f?d=h>i?-1:h<i?1:null:d=h>i?1:h<i?-1:null;if(d)return!1}),d}):c.call(this,a)},limit:function(a){var c=b(this.store,[]),d,e;for(d=0,e=this.length;d<a&&d<e;d++)c.push(this[d]);return c},each:function(a){var b=this;return $.each(b,function(c,d){a.apply(b,[d,c])}),b},filter:function(a,c){var d=this,c=c!==undefined?c:d,e=b(d.store,[]);return e.ast=d.ast,e.ast.value.push({type:"function",value:a}),$.each(d,function(b,f){a.call(c,f,b,d)&&e.push(f)}),e},map:function(a,c){var d=this,e=b(d.store,[]),c=c!==undefined?c:d;return $.each(d,function(b,f){e.push(a.call(c,f,b,d))}),e},reduce:function(a,b){var c=b===undefined?1:0,d=c?this[0]:b,e=this,f=this.length,g;for(;c<f;c++)g=e[c],d=a.call(undefined,d,g,c,e);return d},unique:function(){var a={},c=this,d=b(c.store,[]);return $.each(this,function(b,c){a[c.title]?c.lastSync||(a[c.title]=c):a[c.title]=c}),$.each(a,function(a,b){d.push(b)}),d},bind:function(b){var c=this,d=function(){b.apply(c,arguments)};return c.store.bind("filter",a.createTester(c.ast),d),c},save:function(a){var b=this;return $.each(b,function(c,d){b.store.save(d,a)}),b},add:function(a){var b=this;return a instanceof tiddlyweb.Tiddler?(b.push(a),b.store.add(a)):$.each(a,function(c,d){b.push(d),b.store.add(a)}),b}},b}),define("event",[],function(){return function(){var a={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]},filter:[]},b={bind:function(b,c,d){b==="filter"?a.filter.push({test:c,callback:d}):a[b]&&(c?(a[b][c+b]||(a[b][c+b]=[]),a[b][c+b].push(d)):a[b].all.push(d))},unbind:function(b,c,d){var e=function(a){return d?($.each(a,function(b,c){d===c&&a.splice(b,1)}),a):[]};b==="filter"?$.each(a.filter,function(b,c){c.test===d&&a.filter.splice(b,1)}):a[b]&&c?a[b][c+b]=e(a[b][c+b]):a[b].all=e(a[b].all)},trigger:function(b,c,d){var e=$.isArray(d)?d:[d],f,g=this;a[b]&&($.each(a[b].all,function(a,b){b.apply(g,e)}),c&&a[b][c+b]&&$.each(a[b][c+b],function(a,b){b.apply(g,e)})),b==="tiddler"&&(f=d instanceof tiddlyweb.Tiddler?d:d[0],$.each(a.filter,function(a,b){b.test(f)&&b.callback.apply(g,e)}))}};return b}}),define("cache",[],function(){var a=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}();return{isCaching:a,set:function(b,c){a&&window.localStorage.setItem(b,JSON.stringify(c.baseData()))},get:function(b,c){var d,e;return a?(e=window.localStorage[b],d=new tiddlyweb.Tiddler(c.title),d=d.parse(JSON.parse(e)),d.bag=c.bag,d):null},remove:function(b){a&&window.localStorage.removeItem(b)},each:function(b){var c,d;if(a)for(c=0,d=window.localStorage.length;c<d;c++)try{var e=window.localStorage.key(c),f,g,h,i,j;f=e.split("/");if(f.length!==2)throw"BadKey";g=decodeURIComponent(f[0]),h=decodeURIComponent(f[1]),i=JSON.parse(window.localStorage[e]),j=new tiddlyweb.Tiddler(h),j=j.parse(i),g&&(j.bag=new tiddlyweb.Bag(g,"/"));if(b(j)===!1)break}catch(k){}},clear:function(){a&&window.localStorage.clear()}}}),define("localStore",["cache"],function(a){return function(b){var c={},d=[],e=b.addLastSync!==undefined?b.addLastSync:!0,f=b.useCache,g=function(a){var b=a.bag||"";return encodeURIComponent(b.name)+"/"+encodeURIComponent(a.title)},h=function(a){return $.extend(!0,new tiddlyweb.Tiddler,a)},i=function(a){var b=c[g(a)],e,f,i;if(b)return h(b);if(!a.bag){e=$.extend(new tiddlyweb.Tiddler,a);for(f=0,i=d.length;f<i;f++){a.bag=d[f],b=c[g(a)];if(b)return h(b)}}return null},j=function(b){var i=$.map(d,function(a,b){return b.name});k(new tiddlyweb.Tiddler(b.title)),b.bag&&!~i.indexOf(b.bag.name)&&d.push(b.bag),b.lastSync=e?new Date:null;var j=g(b);c[j]=h(b),f&&a.set(j,b)},k=function(b){var d=g(b),e=c[d];return delete c[g(b)],f&&a.remove(d),e},l=function(a){var b,d;for(b in c)if(c.hasOwnProperty(b)){d=h(c[b]);if(a(d,d.title)===!1)return!1}return!0},m=function(){return d},n=function(){return $.isEmptyObject(c)};return{get:i,set:j,remove:k,each:l,bags:m,isEmpty:n}}}),define("host",[],function(){return function(a){var b,c=[];a instanceof tiddlyweb.Recipe||a instanceof tiddlyweb.Bag?b={pullFrom:a,pushTo:a}:a&&(b={pullFrom:a.pullFrom,pushTo:a.pushTo});var d=function(a){$.ajax({url:"/?limit=1",dataType:"json",success:function(b){var c=($.isArray(b)?b[0].recipe:b.recipe)||"",d=c.match(/^(.+)_[^_]+$/),e;d&&c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Bag(d[1]+"_public","/")}):c?a({pullFrom:new tiddlyweb.Recipe(c,"/"),pushTo:new tiddlyweb.Recipe(c,"/")}):(e=$.isArray(b)?b[0].bag:b.bag,a({pullFrom:new tiddlyweb.Bag(e,"/"),pushTo:new tiddlyweb.Bag(e,"/")}))},error:function(b,c,d){a(null,d,b)}})},e=function(a){$.ajax({url:"/status",dataType:"json",success:function(b){var c=b.space;c?a({pullFrom:new tiddlyweb.Recipe(c.recipe,"/"),pushTo:new tiddlyweb.Bag(c.name+"_public","/")}):d(a)},error:function(b,c,e){d(a)}})},f=function(a){var d=function(a){return $.each(c,function(b,c){c(a)}),c=[],a};a&&c.push(a);if(b)return d(b);c.length===0&&e(function(a){b=a,d(a)})};return f(),{getDefault:f}}}),define("utils",[],function(){var a=function(b,c){for(name in b)switch(typeof b[name]){case"object":if(!a(b[name],c[name]))return!1;break;case"function":break;default:if(b[name]!==c[name])return!1}for(name in c)if(typeof b[name]=="undefined"&&typeof c[name]!="undefined")return!1;return!0},b=function(a,b){this.name=a,this.message=b};b.prototype=new Error,b.prototype.constructor=b;var c=function(b){return function(c,d){var e=c.get(d),f,g;return f=function(){return e&&e.lastSync&&e.revision!==d.revision},g=function(){return e&&!e.lastSync&&!a(d,e)},c.set(d),d.bag&&(!e||f()||g())&&b.trigger("tiddler",d.title,d),!0}};return{isEqual:a,chrjsError:b,replace:c}}),define("refresh",["utils"],function(a){return function(b){var c={},d=function(a,c){var d=$.map(c,function(a){return a.bag.name+a.title});a.each(function(c){~d[(c.bag&&c.bag.name)+c.title]||c.get(function(){},function(){a.remove(c),b.trigger("tiddler",c.title,[c,"deleted"])})})},e=function(b,c){c=c||function(){},b.tiddlers.get(function(e){$.each(e,function(c,d){a.replace(b.store,d)}),d(b.store,e),c(e)},function(b,d,e){c(null,new a.chrjsError("RefreshError","Error refreshing tiddlers: "+e),b)})};return{refresh:function(a,b){typeof a!="function"?e(a,b):this.each(function(b){e(b,a)})},set:function(a,b){c[b.route()]={tiddlers:b.tiddlers?b.tiddlers():b,store:a}},each:function(a){$.each(c,function(b,c){return a(c)})}}}}),define("store",["collection","event","cache","localStore","host","refresh","utils"],function(a,b,c,d,e,f,g){return function(h,i,j){var k;k=function(b,c){return a(k).find(b,c)},$.extend(k,{Collection:function(){var b=Array.prototype.slice.call(arguments);return b.unshift(k),a.apply(null,b)},fn:a.fn});var l=b();$.each(l,function(a,b){k[a]=function(){return b.apply(k,arguments),k}});var m=e(j);$.extend(k,{recipe:null,getDefaults:function(a){var b=m.getDefault(function(b){k.recipe=b.pullFrom,a&&a(b)});return a?k:b}});var n=f(l);k.getDefaults(function(a){n.set(o,a.pullFrom)}),$.extend(k,{refresh:function(b){return n.refresh(function(c){c?b.call(k,a(k,c)):b.apply(k,arguments)}),k},search:function(b,c){return k.getDefaults(function(d){var e=new tiddlyweb.Search(b,d.pullFrom.host);n.set(o,e),n.refresh(e,function(b){b?c.call(k,a(k,b)):c.apply(k,arguments)})}),k}});var o=d({addLastSync:!0}),p=d({addLastSync:!1,useCache:!0}),q=g.isEqual,r=g.chrjsError,s=g.replace(l),t=function(a){if(typeof a=="string"||a instanceof tiddlyweb.Tiddler){var b=typeof a=="string"?!0:!1,c=b?new tiddlyweb.Tiddler(a):a,d={};return d.modified=p.get(c),d.store=o.get(c),d.title=c.title,d.rawTiddler=c,d.tiddler=d.modified||d.store||(b?null:a),d}return{}};return k.get=function(a,b,c,d){var e=t(a),f=function(a){s(o,a),b.call(k,a)},g=function(a,c,d){b.call(k,null,new r("GetTiddlerError","Error getting tiddler: "+d),a)};return e.tiddler&&d&&!e.modified&&(e.tiddler=o.get(e.tiddler)),b?(!d&&e.modified?b.call(k,e.tiddler):e.tiddler?e.tiddler.get(f,g,c?"render=1":""):b&&e.title&&k.getDefaults(function(a){var b=new tiddlyweb.Tiddler(e.title,a.pullFrom);b.get(f,g)}),k):e.tiddler},k.each=function(a){return $.each([p,o],function(b,c){return c.each(a)}),k},k.add=function(a){var b=function(a){s(p,a)};return a.bag?b(a):(b(a),k.getDefaults(function(c){a.bag=c.pushTo,b(a)})),k},k.save=function(a,b){var c=t(a),d=b||a||function(){},a=c.modified||c.rawTiddler,e;return e=function(a,b){var c=p.get(a);if(!a.bag&&!a.recipe){k.getDefaults(function(c){a.bag=c.pushTo,e(a,b)});return}a.put(function(d){q(c,p.get(a))&&p.remove(a),s(o,d),b(d)},function(d,e,f){var g=p.get(a);(!g||!q(c,a)&&q(c,g))&&s(p,a),b(null,new r("SaveError","Error saving "+a.title+": "+f),d)})},a?(e(a,d),k):(p.isEmpty()?d(null,new r("EmptyError","Nothing to save")):p.each(function(a){e(a,d)}),k)},k.remove=function(a){var b=t(a);return b.modified?(p.remove(b.modified),k.trigger("tiddler",b.modified.title,[b.modified,"deleted"]),b.modified):null},k.destroy=function(a,b){var c=t(a),d=function(a){o.remove(a),c.modified&&k.remove(c.modified),k.trigger("tiddler",a.title,[a,"deleted"]),b(a)};return c.store&&(c.store.bag||c.store.recipe)?c.store["delete"](d,function(a,d,e){b(null,new r("DeleteError","Error deleting "+c.tiddler.title+": "+e),a)}):c.modified&&d(c.modified),k},k.retrieveCached=function(){return c.each(function(a){s(p,a)}),k},(i||i===undefined)&&k.retrieveCached(),$.ajaxSetup({beforeSend:function(a){a.setRequestHeader("X-ControlView","false")}}),h&&k.refresh(h),k}}),require(["store"],function(a){window.tiddlyweb.Store=a})